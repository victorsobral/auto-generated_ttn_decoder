<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Automatic Javascript Decoder Generator for The Things Network</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="css/style.css">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
  </head>

  <body class="class bg-light p-3 m-1 border-1 bd-example" >

    <div class="container py-3">

    <h1>Automatic TTN Decoder Generator</h1>

        <p> </p>

        <p> This script takes as input a list of json objects representing the packet variables, their types, starting byte position and the conditions to execute each decoding operation. </p>
        <p> </p>

          <div class="form-group">
            <label for="input_params" class="fw-bold">Template decoder json: </label>
            <textarea class="form-control"  rows="100" id="input_params" style="height: 200px"></textarea>
          </div>

          <p> </p>

          <div class="form-group">
             <label for="output_js" class="fw-bold">TTN javascript decoder: </label>
             <textarea class="form-control"  rows="100" id="output_js" style="height: 200px"></textarea>   
          </div>

          <p> </p>

          <button class="btn btn-primary" onclick="generateFunction()" id="generate_btn">Generate decoder's javascript</button>

          <button type="button" class="btn btn-secondary" onclick="copyFunction()" id="copy_btn">
            copy to clipboard 
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16">
                  <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"></path>
                  <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"></path>
                </svg>
          </button>
        

    </div>

    <div id = "liveAlertPlaceholder"></div>

    <script  type="text/javascript" src="javascript/decoder_auto_generator.js">
    </script>

    <script>


      const alertPlaceholder = document.getElementById('liveAlertPlaceholder')

      const alert = (message, type) => {
        const wrapper = document.createElement('div')
        wrapper.innerHTML = [
          `<div class="alert alert-${type} alert-dismissible" role="alert">`,
          `   <div>${message}</div>`,
          '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
          '</div>'
        ].join('')

        alertPlaceholder.append(wrapper)
      };

      function generateFunction() {
          var input_params = document.getElementById('input_params').value;
          var decoding_instructions = JSON.parse(input_params);

          if(!(Array.isArray(decoding_instructions))){
              decoding_instructions = Array(decoding_instructions);
           } 

          document.getElementById("output_js").value = generate_decoder(decoding_instructions);

          alert('Javascript decoder successfully generated!', 'success');
          
      }

      function copyFunction(){
        navigator.clipboard.writeText(document.getElementById("output_js").value);
        alert('Code sucessfully copied', 'success');
      }
  

    </script>
     

  </body>
</html>

<!-- 

Packets: 
   if $protocol_version==3 : "<BHff"
   [["protocol_version", "B", [0]], ["voltage", "H", [1]], ["pressure", "f",[3]], ["temperature","f",[7]]]
   
   if $protocol_version<=2 : "<BH"
   [["protocol_version", "B", [0]], ["voltage", "H", [1]]]

   default: "<BHf"
   [["protocol_version", "B", [0]], ["voltage", "H", [1]], ["pressure", "f",[3]]], 

Example of a valid input:

[
{
  "battery_voltage": {
    "displayName": "Battery voltage",
    "unit": "V",
    "value": "($<H[1]*3.3)/1000"
  },
  "device_id": 5100,
  "pressure": {
    "displayName": "Pressure",
    "unit": "bar",
    "value":"$<f[3]"
  },
  "protocol_version": "$B[0]",
  "temperature": {
    "displayName": "Temperature",
    "unit": "\u00B0C",
    "value": "$<f[7]"
  },
  "?":"$B[0]==3"
},

{
  "battery_voltage": {
    "displayName": "Battery voltage",
    "unit": "V",
    "value": "($<H[1]*3.3)/1000"
  },
  "device_id": 5100,
  "protocol_version": "$B[0]",
  "?":"$B[0]<=2"
},

{
  "battery_voltage": {
    "displayName": "Battery voltage",
    "unit": "V",
    "value": "($<H[1]*3.3)/1000"
  },
  "device_id": 5100,
  "pressure": {
    "displayName": "Pressure",
    "unit": "bar",
    "value":"$<f[3]"
  },
  "protocol_version": "$B[0]"
}
]
 -->